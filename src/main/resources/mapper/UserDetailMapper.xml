<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wait.mapper.UserDetailMapper">

    <!-- 基础字段映射，处理JSON类型的preferences字段 -->
    <resultMap id="BaseResultMap" type="com.wait.entity.domain.UserDetail">
        <id column="id" property="id" />
        <result column="user_id" property="userId" />
        <result column="real_name" property="realName" />
        <result column="gender" property="gender" />
        <result column="birthday" property="birthday" />
        <result column="avatar" property="avatar" />
        <result column="signature" property="signature" />
        <result column="country" property="country" />
        <result column="province" property="province" />
        <result column="city" property="city" />
        <result column="address" property="address" />
        <result column="postal_code" property="postalCode" />
        <result column="preferences" property="preferences"
                typeHandler="com.wait.handler.JsonTypeHandler"/>
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
    </resultMap>

    <!-- 根据用户ID查询详情 -->
    <select id="selectByUserId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT id, user_id, real_name, gender, birthday, avatar, signature,
        country, province, city, address, postal_code, preferences,
        create_time, update_time
        FROM user_detail
        WHERE user_id = #{userId}
    </select>

    <!-- 插入用户详情 -->
    <insert id="insert" parameterType="com.wait.entity.domain.UserDetail" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_detail
        (user_id, real_name, gender, birthday, avatar, signature,
        country, province, city, address, postal_code, preferences)
        VALUES
        (#{userId}, #{realName}, #{gender}, #{birthday}, #{avatar}, #{signature},
        #{country}, #{province}, #{city}, #{address}, #{postalCode},
        #{preferences, typeHandler=com.wait.handler.JsonTypeHandler})
    </insert>

    <!-- 更新用户详情 -->
    <update id="update" parameterType="com.wait.entity.domain.UserDetail">
        UPDATE user_detail
        SET real_name = #{realName},
        gender = #{gender},
        birthday = #{birthday},
        avatar = #{avatar},
        signature = #{signature},
        country = #{country},
        province = #{province},
        city = #{city},
        address = #{address},
        postal_code = #{postalCode},
        preferences = #{preferences, typeHandler=com.wait.handler.JsonTypeHandler},
        update_time = NOW()
        WHERE user_id = #{userId}
    </update>

    <!-- 部分更新头像 -->
    <update id="updateAvatar">
        UPDATE user_detail
        SET avatar = #{avatar}, update_time = NOW()
        WHERE user_id = #{userId}
    </update>

    <!-- 部分更新个性签名 -->
    <update id="updateSignature">
        UPDATE user_detail
        SET signature = #{signature}, update_time = NOW()
        WHERE user_id = #{userId}
    </update>

    <!-- 更新偏好设置 -->
    <update id="updatePreferences">
        UPDATE user_detail
        SET preferences = #{preferences, typeHandler=com.wait.handler.JsonTypeHandler},
        update_time = NOW()
        WHERE user_id = #{userId}
    </update>

</mapper>